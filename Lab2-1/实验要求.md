# 实验2:可靠数据传输协议-停等协议的设计与实现

## 1. 实验目的

- 理解可靠数据传输的基本原理
- 掌握停等协议的工作原理
- 掌握基于UDP设计并实现一个停等协议的过程与技术

## 2. 实验环境

- 接入Internet的实验主机
- Windows操作系统
- 开发语言:C/C++(或Java)等

## 3. 实验内容

### 必做内容

1. **基于UDP设计一个简单的停等协议**,实现单向可靠数据传输(服务器到客户的数据传输)
2. **模拟引入数据包的丢失**,验证所设计协议的有效性

### 选做内容(加分项目)

1. **改进所设计的停等协议**,支持双向数据传输(可以当堂完成或课下完成)
2. **基于所设计的停等协议**,实现一个C/S结构的文件传输应用(可以当堂完成或课下完成)

## 4. 实验方式

每位同学独立上机编程实验,实验指导教师现场指导。

## 5. 实验要点

### 5.1 协议设计要点

1. **差错检测**
   - 基于UDP实现的停等协议,可以不进行差错检测
   - 可以利用UDP协议差错检测
2. **数据丢失验证**
   - 为了验证所设计协议是否可以处理数据丢失,可以考虑在数据接收端或发送端引入数据丢失
3. **分组格式设计**
   - 在开发停等协议之前,需要先设计协议数据分组格式
   - 需要设计确认分组格式

### 5.2 计时器实现方法

有两种实现方式:

#### 方式1:阻塞socket

使用`setsockopt()`函数设置套接字发送与接收超时时间:

```c
int setsockopt(int socket, int level, int option_name, 
               const void* option_value, size_t option_len)
```

#### 方式2:非阻塞socket

使用累加sleep时间的方法判断socket接收数据是否超时:

- 当时间累加量超过一定数值时则认为套接字接收数据超时

## 6. 实验报告

在实验报告中要说明:

1. **协议设计**
   - 所设计停等协议数据分组格式
   - 确认分组格式
   - 各个域的作用
2. **流程设计**
   - 协议两端程序流程图
   - 协议典型交互过程
3. **测试验证**
   - 数据分组丢失验证模拟方法
   - 实验验证结果
4. **技术实现**
   - 程序实现的主要类(或函数)及其主要作用
   - UDP编程的主要特点
5. **源代码**
   - 详细注释的源程序

------

## 附录:停等协议基本原理

### 工作流程

1. **发送方**:
   - 发送一个数据帧
   - 启动计时器
   - 等待接收方的确认(ACK)
2. **接收方**:
   - 接收数据帧
   - 检查数据帧是否正确
   - 发送确认(ACK)或否认(NAK)
3. **超时重传**:
   - 如果发送方在超时时间内未收到ACK
   - 重新发送数据帧

### 协议特点

- ✅ 简单易实现
- ✅ 可靠性高
- ⚠️ 效率较低(信道利用率低)
- ⚠️ 适用于往返时延较小的网络

### 关键技术点

1. **序列号**:使用0和1两个序列号交替使用
2. **确认机制**:接收方发送ACK确认
3. **超时重传**:发送方超时后重传数据帧
4. **差错检测**:利用校验和检测数据帧错误