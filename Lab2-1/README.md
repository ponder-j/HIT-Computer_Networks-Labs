# Lab2-1: 停等协议 (Stop-and-Wait Protocol)

## 实验简介

本实验基于UDP协议实现了一个简单的停等协议,实现从服务器到客户端的单向可靠数据传输。

## 协议设计

### 数据帧格式

```
+------+------------------+------+
| Seq  |      Data        | Flag |
+------+------------------+------+
1字节    ≤1024字节         1字节
```

- **Seq**: 序列号,使用0和1两个值交替
- **Data**: 传输的数据内容
- **Flag**: 标志位,0表示普通数据帧,1表示最后一帧

### ACK帧格式

```
+------+
| ACK  |
+------+
1字节
```

- **ACK**: 确认序列号,值为0或1

## 工作原理

1. **发送方(服务器)**:
   - 发送数据帧(Seq=0或1)
   - 启动计时器等待ACK
   - 收到正确ACK后发送下一帧(切换Seq)
   - 超时未收到ACK则重传当前帧
   - 最多重传5次

2. **接收方(客户端)**:
   - 接收数据帧
   - 检查序列号是否正确
   - 发送对应的ACK
   - 可模拟丢包场景

## 文件说明

- `server.cpp`: 服务器端程序
- `client.cpp`: 客户端程序
- `实验要求.md`: 实验要求文档

## 编译说明

### 使用g++编译 (MinGW)

```bash
# 编译服务器
g++ server.cpp -o server.exe -lws2_32

# 编译客户端
g++ client.cpp -o client.exe -lws2_32
```

### 使用MSVC编译

```bash
# 编译服务器
cl server.cpp /Fe:server.exe ws2_32.lib

# 编译客户端
cl client.cpp /Fe:client.exe ws2_32.lib
```

## 运行说明

### 1. 启动服务器

```bash
./server.exe
```

服务器将在端口12340上监听。

### 2. 启动客户端

在另一个终端窗口运行:

```bash
./client.exe
```

### 3. 可用命令

客户端支持以下命令:

- `-time`: 获取服务器时间
- `-test [丢包率]`: 测试停等协议
  - 丢包率范围: 0.0-1.0 (默认0.2,即20%)
  - 示例: `-test 0.3` (30%丢包率)
- `-quit`: 退出客户端
- 其他文本: 回显测试

## 测试示例

### 1. 正常传输测试

```
请输入命令: -test 0
```

这将以0%丢包率测试停等协议,所有数据包都能正常传输。

### 2. 模拟丢包测试

```
请输入命令: -test 0.3
```

这将以30%丢包率测试停等协议,可以观察到:
- 数据包丢失时不发送ACK
- 服务器超时后重传
- 最终所有数据包都能可靠送达

### 3. 时间查询测试

```
请输入命令: -time
```

服务器将返回当前系统时间。

## 关键技术点

### 1. 序列号机制
- 使用0和1两个序列号交替
- 发送方每次成功收到ACK后切换序列号
- 接收方检查序列号,只接受期望的序列号

### 2. 超时重传
- 使用`select()`实现超时机制
- 超时时间设置为2秒
- 最多重传5次

### 3. 丢包模拟
- 客户端使用随机数模拟丢包
- 丢包时不发送ACK,触发服务器超时重传

### 4. 可靠传输
- 通过序列号和ACK机制确保数据按序到达
- 通过超时重传机制处理数据包丢失

## 实验结果

### 预期结果

1. **无丢包情况**: 所有数据包一次传输成功
2. **有丢包情况**:
   - 观察到数据包丢失
   - 服务器超时重传
   - 最终所有数据包成功传输

### 验证要点

- ✓ 序列号正确切换(0->1->0->1...)
- ✓ 超时重传机制正常工作
- ✓ ACK确认机制正确
- ✓ 数据完整性保证
- ✓ 丢包模拟有效

## 协议特点

### 优点
- 实现简单
- 可靠性高
- 易于理解和调试

### 缺点
- 信道利用率低(每次只能发送一个包)
- 往返时延影响大
- 效率较低

## 改进方向

1. 支持双向数据传输
2. 实现文件传输功能
3. 添加校验和进行差错检测
4. 动态调整超时时间

## 注意事项

1. 确保防火墙允许UDP 12340端口通信
2. 先启动服务器再启动客户端
3. 如果端口被占用,修改SERVER_PORT宏定义
4. Windows环境需要链接ws2_32.lib库
