# HTTP 代理服务器缓存功能测试指南

## 📋 测试环境准备

### 文件清单
- `test_cache_server.py` - 支持缓存验证的 HTTP 测试服务器
- `cache_test.html` - 缓存功能测试页面
- `index.html` - 基础测试页面
- `ProxyServerWithCache.exe` - 带缓存的代理服务器

---

## 🚀 完整测试流程

### 步骤 1: 启动测试 HTTP 服务器

```bash
# 进入测试目录
cd D:\Grade3_Courses\Computer_Networks_Labs\Lab1\test_http_server

# 启动测试服务器（需要管理员权限，因为使用端口 80）
python test_cache_server.py
```

**预期输出：**
```
============================================================
HTTP 缓存测试服务器
============================================================
监听端口: 80
工作目录: D:\Grade3_Courses\Computer_Networks_Labs\Lab1\test_http_server
启动时间: 2025-10-14 17:30:00

功能说明:
  ✓ 支持 Last-Modified 响应头
  ✓ 支持 If-Modified-Since 请求头验证
  ✓ 自动返回 304 Not Modified（当文件未修改时）

测试页面:
  http://127.0.0.1:80/cache_test.html
  http://127.0.0.1:80/index.html

按 Ctrl+C 停止服务器
============================================================
```

---

### 步骤 2: 启动代理服务器

**打开新的命令行窗口**

```bash
# 进入 Lab1 目录
cd D:\Grade3_Courses\Computer_Networks_Labs\Lab1

# 运行带缓存的代理服务器
ProxyServerWithCache.exe
```

**预期输出：**
```
========================================
   HTTP 代理服务器 v2.0 (带缓存)
========================================
代理服务器正在启动...
缓存系统初始化完成
初始化Socket...
代理服务器启动成功!
监听端口: 8080
缓存目录: cache\
等待客户端连接...
========================================
```

---

### 步骤 3: 配置浏览器代理

#### Firefox（推荐使用 SwitchyOmega 插件）:
1. 安装 SwitchyOmega 插件
2. 创建新的代理配置：
   - 协议：HTTP
   - 服务器：127.0.0.1
   - 端口：8080
3. 启用代理

#### 或手动配置：
1. 设置 → 网络设置 → 手动代理配置
2. HTTP 代理：127.0.0.1
3. 端口：8080
4. 勾选"也将此代理用于 HTTPS"（可选）

---

### 步骤 4: 首次访问测试页面

**在浏览器中访问：**
```
http://127.0.0.1/cache_test.html
```

#### 观察测试服务器输出：
```
============================================================
[请求] GET /cache_test.html
[时间] 2025-10-14 17:35:00
[文件信息] 路径: D:\...\cache_test.html
[文件信息] 大小: 8192 字节
[文件信息] Last-Modified: Sun, 14 Oct 2025 09:35:00 GMT
[200] 首次请求，返回完整内容
============================================================
```

#### 观察代理服务器输出：
```
[新连接] 客户端: 127.0.0.1:xxxxx
[接收] 收到 xxx 字节的HTTP请求
[解析] 方法: GET, 主机: 127.0.0.1, URL: /cache_test.html
[连接] 成功连接到目标服务器: 127.0.0.1
[转发] 已转发请求到目标服务器 (xxx 字节)
[完成] 已转发响应到客户端 (总计 8192 字节)
[缓存] 已保存: 127.0.0.1/cache_test.html (8192 字节)  ← 关键信息！
[关闭] 关闭连接
```

#### 验证缓存文件：
```bash
# 查看 cache 目录
dir cache\

# 应该看到类似 xxxxxxxx.cache 的文件
```

---

### 步骤 5: 再次访问（验证缓存）

**刷新页面（按 F5）**

#### 观察测试服务器输出：
```
============================================================
[请求] GET /cache_test.html
[时间] 2025-10-14 17:36:00
[缓存验证] 收到 If-Modified-Since: Sun, 14 Oct 2025 09:35:00 GMT  ← 关键！
[文件信息] 路径: D:\...\cache_test.html
[文件信息] 大小: 8192 字节
[文件信息] Last-Modified: Sun, 14 Oct 2025 09:35:00 GMT
[304] 文件未修改，返回 304 Not Modified  ← 关键！
============================================================
```

#### 观察代理服务器输出：
```
[新连接] 客户端: 127.0.0.1:xxxxx
[接收] 收到 xxx 字节的HTTP请求
[解析] 方法: GET, 主机: 127.0.0.1, URL: /cache_test.html
[缓存] 找到缓存，验证新鲜度...  ← 关键信息！
[连接] 成功连接到目标服务器: 127.0.0.1
[转发] 已转发请求到目标服务器 (xxx 字节)
[缓存] 服务器返回304，使用缓存  ← 关键信息！
[完成] 已转发响应到客户端 (总计 8192 字节)
[关闭] 关闭连接
```

---

## ✅ 成功标准

### 必须满足的条件：

1. **首次访问：**
   - [ ] 测试服务器返回 200 OK
   - [ ] 代理服务器输出包含 `[缓存] 已保存`
   - [ ] `cache\` 目录生成了 `.cache` 文件

2. **第二次访问：**
   - [ ] 测试服务器收到 `If-Modified-Since` 头部
   - [ ] 测试服务器返回 304 Not Modified
   - [ ] 代理服务器输出包含 `[缓存] 找到缓存，验证新鲜度...`
   - [ ] 代理服务器输出包含 `[缓存] 服务器返回304，使用缓存`

3. **性能对比：**
   - [ ] 第二次访问速度明显快于第一次
   - [ ] 浏览器开发者工具（F12 → Network）显示第二次请求更快

---

## 🔍 详细验证方法

### 方法 1: 查看浏览器开发者工具

**按 F12 打开开发者工具 → Network 标签**

#### 首次访问：
```
Name              Status    Type        Size       Time
cache_test.html   200       document    8.2 KB     150ms
```

#### 第二次访问：
```
Name              Status    Type        Size       Time
cache_test.html   304       document    (cached)   20ms
```

### 方法 2: 检查缓存文件

```bash
# 查看缓存目录
cd D:\Grade3_Courses\Computer_Networks_Labs\Lab1\cache

# 列出所有缓存文件
dir

# 查看缓存文件内容（前 100 字节）
powershell "Get-Content .\*.cache -Encoding Byte -TotalCount 100"
```

应该看到 HTTP 响应头和 HTML 内容。

### 方法 3: 使用 curl 测试

```bash
# 首次请求（通过代理）
curl -v -x http://127.0.0.1:8080 http://127.0.0.1/cache_test.html

# 第二次请求（应该看到 304）
curl -v -x http://127.0.0.1:8080 http://127.0.0.1/cache_test.html
```

---

## 🐛 常见问题排查

### 问题 1: 看不到缓存相关输出

**可能原因：**
- 代理服务器未正确编译
- 浏览器未配置代理
- 访问的是 HTTPS 网站（不支持）

**解决方法：**
- 重新编译 `ProxyServerWithCache.cpp`
- 确认浏览器代理配置
- 确保访问 `http://127.0.0.1`（HTTP，不是 HTTPS）

### 问题 2: 始终返回 200，看不到 304

**可能原因：**
- 测试服务器未正确处理 `If-Modified-Since`
- 代理服务器未添加 `If-Modified-Since` 头部
- 文件时间比较逻辑错误

**解决方法：**
- 检查测试服务器日志，确认收到 `If-Modified-Since`
- 使用 Wireshark 或 Fiddler 抓包查看请求头
- 检查代码中的时间比较逻辑

### 问题 3: 缓存文件未生成

**可能原因：**
- `cache\` 目录不存在
- 没有写入权限
- 代码中 `SaveToCache` 未被调用

**解决方法：**
- 手动创建 `cache\` 目录
- 以管理员身份运行代理服务器
- 添加调试输出确认是否执行到保存逻辑

### 问题 4: 端口 80 被占用

**错误信息：** `OSError: [WinError 10048] 通常每个套接字地址只允许使用一次`

**解决方法：**
```bash
# 查看占用端口 80 的进程
netstat -ano | findstr :80

# 停止 IIS 服务（如果安装了）
net stop was /y

# 或者修改测试服务器使用其他端口（如 8000）
# 修改 test_cache_server.py 中的 PORT = 8000
# 然后访问 http://127.0.0.1:8000/cache_test.html
```

---

## 📊 测试数据记录表

| 测试项 | 首次访问 | 第二次访问 | 第三次访问 | 结果 |
|--------|---------|-----------|-----------|------|
| HTTP 状态码 | 200 | 304 | 304 | ✅ |
| 响应时间 | 150ms | 20ms | 20ms | ✅ |
| 数据大小 | 8.2KB | cached | cached | ✅ |
| 代理日志-保存缓存 | ✅ | - | - | ✅ |
| 代理日志-使用缓存 | - | ✅ | ✅ | ✅ |
| 缓存文件存在 | ✅ | ✅ | ✅ | ✅ |

---

## 🎯 高级测试

### 测试缓存更新

1. 访问页面（生成缓存）
2. 修改 `cache_test.html` 文件内容
3. 再次访问
4. **预期：** 服务器返回 200（文件已修改），代理更新缓存

### 测试 POST 请求

1. POST 请求**不应该**被缓存
2. 观察代理服务器是否跳过缓存逻辑

### 清空缓存测试

```bash
# 删除所有缓存
rd /s /q cache
mkdir cache

# 重新访问，应该像首次访问一样
```

---

## 📝 实验报告建议内容

1. **测试环境说明**
   - 操作系统版本
   - 编译器版本
   - 浏览器版本

2. **测试步骤截图**
   - 代理服务器输出截图
   - 测试服务器输出截图
   - 浏览器 Network 面板截图
   - 缓存目录文件列表截图

3. **结果分析**
   - 首次访问与缓存访问的性能对比
   - HTTP 请求头和响应头分析
   - 缓存命中率计算

4. **代码说明**
   - 缓存数据结构设计
   - If-Modified-Since 实现原理
   - 304 响应处理流程

---

## 🎉 恭喜！

如果您完成了所有测试步骤并且都通过，说明您的 HTTP 代理服务器缓存功能实现正确！

**核心功能验证清单：**
- ✅ 缓存保存功能
- ✅ 缓存读取功能
- ✅ If-Modified-Since 验证
- ✅ 304 响应处理
- ✅ Last-Modified 提取
- ✅ 多线程安全（临界区锁）
