# 缓存代理服务器测试指南

## 📋 目录结构

```
test_server/
├── www/                    # 网站文件目录
│   ├── index.html         # 测试导航主页
│   ├── static.html        # 静态HTML测试
│   ├── dynamic.php        # 动态内容测试
│   ├── timestamp.php      # 时间戳测试
│   ├── no-cache.php       # 无缓存测试
│   ├── headers.php        # HTTP头查看器
│   └── test-image.php     # 图片缓存测试
├── conf/                  # Nginx配置（如果需要）
└── TESTING_GUIDE.md       # 本文档
```

## 🚀 快速开始

### 1. 启动测试服务器

确保你的Alpine Nginx+PHP7.3环境已经配置好，并将 `www/` 目录中的文件部署到Web服务器的根目录。

**Docker方式：**
```bash
docker run -d -p 80:80 -v $(pwd)/www:/var/www/html --name test-server your-nginx-php-image
```

**本地Nginx：**
```bash
# 将www目录内容复制到Nginx的html目录
cp -r www/* /usr/share/nginx/html/
# 或者配置Nginx指向www目录
```

### 2. 启动代理服务器

```bash
cd Lab1
ProxyServerWithCache.exe
```

代理服务器将在 **10240** 端口监听。

### 3. 配置浏览器代理

**Firefox:**
- 设置 → 网络设置 → 手动代理配置
- HTTP 代理: `127.0.0.1`, 端口: `10240`

**Chrome/Edge:**
- 设置 → 系统 → 代理设置
- HTTP 代理: `127.0.0.1:10240`

### 4. 访问测试页面

在浏览器中访问：
```
http://localhost/index.html
```

## 🧪 测试用例

### 测试1：静态HTML缓存

**文件：** `static.html`

**测试步骤：**
1. 首次访问 `http://localhost/static.html`
2. 观察代理日志，应显示：
   ```
   [缓存] 未找到缓存
   [响应] Last-Modified: ...
   [缓存] 已保存缓存
   ```
3. 刷新页面（F5）
4. 观察代理日志，应显示：
   ```
   [缓存] 找到缓存
   [缓存] 添加 If-Modified-Since: ...
   [响应] 状态码: 304
   [缓存] 服务器返回304 Not Modified，缓存仍然有效
   ```

**预期结果：**
- ✅ 首次请求返回200，保存缓存
- ✅ 再次请求添加If-Modified-Since头
- ✅ 服务器返回304
- ✅ ./cache目录生成.cache文件

---

### 测试2：PHP动态内容缓存

**文件：** `dynamic.php`

**测试步骤：**
1. 访问 `http://localhost/dynamic.php`
2. 记录页面显示的"页面生成时间"
3. 刷新页面多次
4. 检查"页面生成时间"是否保持不变

**预期结果：**
- ✅ 首次访问显示当前时间
- ✅ 多次刷新，时间**始终相同**（说明使用了缓存）
- ✅ 页面显示检测到If-Modified-Since头
- ✅ 显示"匹配！服务器应返回304"

---

### 测试3：时间戳验证

**文件：** `timestamp.php`

**测试步骤：**
1. 访问 `http://localhost/timestamp.php`
2. 记录大字显示的时间
3. 连续刷新10次
4. 检查时间是否改变

**预期结果：**
- ✅ 时间保持不变 → 缓存工作正常
- ❌ 时间不断变化 → 缓存失效或未使用缓存

**这是最直观的测试！**

---

### 测试4：无缓存页面

**文件：** `no-cache.php`

**测试步骤：**
1. 访问 `http://localhost/no-cache.php`
2. 记录显示的时间
3. 刷新页面
4. 检查时间是否改变

**预期结果：**
- ✅ 每次刷新，时间**都会改变**
- ✅ 代理日志显示"响应无Last-Modified头，不缓存"
- ✅ 不应在./cache目录生成缓存文件

**说明：** 此测试验证代理不会错误地缓存不应缓存的内容。

---

### 测试5：HTTP头信息查看

**文件：** `headers.php`

**测试步骤：**
1. 访问 `http://localhost/headers.php`
2. 查看"客户端请求头"部分
3. 刷新页面
4. 检查是否出现"If-Modified-Since"头

**预期结果：**
- ✅ 首次请求：无If-Modified-Since头
- ✅ 再次请求：出现If-Modified-Since头，并高亮显示
- ✅ 页面顶部显示"检测到缓存验证请求！"

---

### 测试6：图片资源缓存

**文件：** `test-image.php`

**测试步骤：**
1. 访问 `http://localhost/test-image.php`
2. 查看"页面生成时间"
3. 多次刷新
4. 验证时间是否保持不变

**预期结果：**
- ✅ 时间保持不变
- ✅ 显示缓存验证信息
- ✅ 模拟图片的缓存行为

---

## 📊 验证缓存的方法

### 方法1：查看时间戳（最简单）

访问 `timestamp.php` 或 `dynamic.php`，多次刷新：
- **时间不变** = 缓存工作 ✅
- **时间改变** = 缓存失败 ❌

### 方法2：查看代理日志

观察ProxyServerWithCache.exe的控制台输出：

**首次请求：**
```
[新连接] 客户端: 127.0.0.1:xxxxx
[接收] 收到 xxx 字节的HTTP请求
[解析] 方法: GET, 主机: localhost:80, URL: /dynamic.php
[缓存] 未找到缓存
[连接] 成功连接到目标服务器: localhost:80
[转发] 已转发请求到目标服务器 (xxx 字节)
[响应] 状态码: 200
[响应] Last-Modified: Mon, 15 Jan 2025 12:00:00 GMT
[完成] 已转发响应到客户端 (总计 xxx 字节)
[缓存] 已保存缓存，大小: xxx 字节
```

**再次请求：**
```
[新连接] 客户端: 127.0.0.1:xxxxx
[接收] 收到 xxx 字节的HTTP请求
[解析] 方法: GET, 主机: localhost:80, URL: /dynamic.php
[缓存] 找到缓存，大小: xxx 字节, Last-Modified: Mon, 15 Jan 2025 12:00:00 GMT
[缓存] 添加 If-Modified-Since: Mon, 15 Jan 2025 12:00:00 GMT
[连接] 成功连接到目标服务器: localhost:80
[转发] 已转发请求到目标服务器 (xxx 字节)
[响应] 状态码: 304
[完成] 已转发响应到客户端 (总计 xxx 字节)
[缓存] 服务器返回304 Not Modified，缓存仍然有效
```

### 方法3：检查缓存文件

查看 `Lab1/cache/` 目录：
```bash
cd Lab1/cache
ls -lh
```

应该看到多个 `.cache` 文件，例如：
```
1234567890.cache
2345678901.cache
3456789012.cache
```

### 方法4：使用浏览器开发者工具

1. 按 F12 打开开发者工具
2. 切换到"网络"(Network)标签
3. 刷新页面
4. 查看请求详情：
   - **请求头** 中应有 `If-Modified-Since`
   - **响应头** 中应有 `Last-Modified`
   - **状态码** 应为 `304 Not Modified`（第二次请求时）

---

## ❓ 常见问题

### Q1: 为什么刷新后时间仍然改变？

**可能原因：**
1. 使用了强制刷新（Ctrl+F5）而不是普通刷新（F5）
2. 代理服务器未启动或未正确配置
3. 浏览器代理设置不正确
4. 代理服务器没有正确处理缓存

**解决方法：**
- 使用普通刷新（F5）
- 检查代理服务器是否运行在10240端口
- 重新配置浏览器代理
- 查看代理服务器日志排查问题

### Q2: 代理日志没有显示"If-Modified-Since"

**可能原因：**
1. 首次请求（正常现象）
2. 缓存文件不存在或损坏
3. 代码逻辑错误

**解决方法：**
- 确保至少访问过一次页面
- 检查./cache目录是否存在且有写权限
- 重新编译代理服务器

### Q3: 服务器返回200而不是304

**可能原因：**
1. Last-Modified时间不匹配
2. 服务器不支持If-Modified-Since
3. 服务器配置问题

**解决方法：**
- 使用 `headers.php` 查看具体的时间值
- 检查PHP脚本是否正确处理If-Modified-Since
- 查看Nginx配置

### Q4: 缓存目录为空

**可能原因：**
1. 代理只转发不缓存
2. 响应没有Last-Modified头
3. SaveCache函数失败

**解决方法：**
- 检查代理日志是否显示"已保存缓存"
- 访问 `dynamic.php` 而不是 `no-cache.php`
- 检查文件写入权限

---

## 🎯 测试清单

完整测试前，请确认以下各项：

- [ ] Web服务器运行正常（端口80）
- [ ] 代理服务器运行正常（端口10240）
- [ ] 浏览器代理配置正确
- [ ] ./cache目录存在且有写权限
- [ ] 可以访问 http://localhost/index.html

**测试结果：**

- [ ] 静态HTML缓存测试通过
- [ ] PHP动态内容缓存测试通过
- [ ] 时间戳验证测试通过（时间不变）
- [ ] 无缓存页面测试通过（时间改变）
- [ ] HTTP头查看器显示If-Modified-Since
- [ ] 图片资源缓存测试通过
- [ ] ./cache目录生成缓存文件
- [ ] 代理日志显示正确的缓存操作

---

## 📝 测试报告模板

```
## 缓存代理服务器测试报告

**测试时间：** 2025-01-15
**测试人员：** [你的姓名]
**环境：** Alpine Linux + Nginx + PHP7.3

### 测试结果总结
- 静态内容缓存：✅ 通过 / ❌ 失败
- 动态内容缓存：✅ 通过 / ❌ 失败
- If-Modified-Since：✅ 正确添加 / ❌ 未添加
- 304响应处理：✅ 正确处理 / ❌ 未处理
- 缓存文件生成：✅ 正常 / ❌ 异常

### 详细测试数据

#### 测试1：dynamic.php
- 首次访问时间：2025-01-15 14:30:25
- 第2次刷新时间：2025-01-15 14:30:25 ✅
- 第3次刷新时间：2025-01-15 14:30:25 ✅
- 结论：缓存工作正常

#### 测试2：no-cache.php
- 首次访问时间：2025-01-15 14:31:10
- 第2次刷新时间：2025-01-15 14:31:15 ✅
- 第3次刷新时间：2025-01-15 14:31:20 ✅
- 结论：正确识别无缓存内容

#### 代理日志截图
[粘贴日志截图或文本]

### 遇到的问题
[记录测试中遇到的问题]

### 解决方法
[记录问题的解决方法]
```

---

## 📞 需要帮助？

如果测试遇到问题：
1. 查看代理服务器控制台日志
2. 查看Web服务器日志（Nginx error.log）
3. 使用 `headers.php` 检查HTTP头
4. 检查防火墙是否阻止10240端口
5. 尝试重启代理服务器和Web服务器

祝测试顺利！🎉
